# <!-- Powered by BMAD™ Core -->

# Story 2.2: Task Status Management and Completion

## Status
Draft

## Story
**As a** family member,  
**I want** to easily update task status and mark items complete,  
**so that** my family can see real-time progress on shared responsibilities.

## Acceptance Criteria

1. **One-tap task completion** with immediate visual feedback and status update
2. **Task status indicators** showing pending, in-progress, and completed states with clear visual design
3. **Assignment transfer** allowing tasks to be reassigned between family members
4. **Task editing capability** for title, due date, and assignment changes after creation
5. **Completion confirmation** with optional notes or comments for complex tasks
6. **Status change visibility** immediately reflected in all family members' views

## Tasks / Subtasks

- [ ] Enhance TaskCard component with status management UI (AC: 1, 2)
  - [ ] Add one-tap completion button with immediate visual feedback
  - [ ] Implement task status indicators (pending, in-progress, completed) with color coding
  - [ ] Add visual state changes for completed tasks (opacity, strikethrough, etc.)
  - [ ] Ensure minimum 44px touch targets for mobile accessibility
  - [ ] Add loading states during status update operations
- [ ] Build task editing functionality (AC: 4)
  - [ ] Create TaskEditModal component with form validation
  - [ ] Implement inline title editing for quick updates
  - [ ] Add due date editing with DueDatePicker integration
  - [ ] Include description editing with auto-resize textarea
  - [ ] Add validation and error handling for edit operations
- [ ] Implement assignment transfer functionality (AC: 3)
  - [ ] Create AssignmentTransfer component with family member selection
  - [ ] Add reassignment dropdown with FamilyMemberSelect integration
  - [ ] Implement family member validation (only allow assignment to family members)
  - [ ] Add visual feedback for assignment changes
  - [ ] Include permission checks for reassignment (creator or current assignee)
- [ ] Create completion confirmation system (AC: 5)
  - [ ] Build CompletionModal component for complex tasks
  - [ ] Add optional completion notes/comments functionality
  - [ ] Implement completion confirmation workflow
  - [ ] Add completion timestamp tracking
  - [ ] Include task completion analytics for family coordination overview
- [ ] Implement backend task update API endpoint (AC: 1, 2, 3, 4, 6)
  - [ ] Enhance PATCH /api/tasks/[taskId] with status updates and optimistic locking
  - [ ] Add real-time updates via Supabase subscriptions for status changes
  - [ ] Implement family data isolation validation for task updates
  - [ ] Add conflict resolution using syncVersion for concurrent edits
  - [ ] Include audit logging for task status changes
- [ ] Set up optimistic UI updates with React Query (AC: 6)
  - [ ] Configure useUpdateTaskMutation with optimistic status updates
  - [ ] Implement immediate UI feedback without waiting for server response
  - [ ] Add proper error handling and rollback on failed updates
  - [ ] Ensure cache invalidation and real-time updates across family members
  - [ ] Handle offline status update queuing for sync when reconnected
- [ ] Create comprehensive testing suite for task status management
  - [ ] Unit tests for TaskCard status interactions and visual states
  - [ ] Component tests for TaskEditModal with form validation scenarios
  - [ ] Integration tests for task status updates with mocked Supabase
  - [ ] API endpoint tests with family isolation and conflict resolution validation
  - [ ] E2E tests for complete task status management workflow using Playwright
  - [ ] Accessibility tests for status indicators and completion buttons

## Dev Notes

### Previous Story Insights
Story 2.1 (Task Creation and Basic Management) successfully established the foundation for task management with comprehensive components including QuickAddModal, TaskTypeSelector, FamilyMemberSelect, and DueDatePicker. The implementation includes optimistic UI updates with React Query, mobile-first design with 44px touch targets, and comprehensive family data isolation. Key architectural patterns established: modular component design, React Query for server state management, Zustand for client state, and comprehensive TypeScript coverage. The existing TaskCard component and useFamilyTasks hook provide the foundation for extending task status management functionality. [Source: docs/stories/2.1.story.md#dev-agent-record]

### Architecture Context

**Core Technology Stack** [Source: docs/architecture/tech-stack.md]
- Frontend Framework: Next.js 14.2+ with App Router for API routes and optimized performance
- UI Framework: Custom components with Tailwind CSS 3.4+ for mobile-first responsive design  
- State Management: React Query 5.0+ for server state with Zustand 4.4+ for client UI state
- Database: Supabase PostgreSQL with built-in authentication and real-time capabilities
- TypeScript: 5.2+ for type safety across components and API calls
- Testing: Jest + React Testing Library for components, Playwright for E2E testing

**Data Models for Task Status Management** [Source: docs/architecture/data-models.md]

**Task Interface for Status Updates:**
```typescript
interface Task {
  id: string;
  familyId: string;
  title: string;
  description?: string;
  assigneeId: string;
  createdById: string;
  dueDate?: Date;
  completedAt?: Date;
  status: 'pending' | 'in_progress' | 'completed';
  category: 'task' | 'event';
  priority: 'low' | 'medium' | 'high';
  createdAt: Date;
  updatedAt: Date;
  syncVersion: number; // For offline conflict resolution
}
```

**API Specifications** [Source: docs/architecture/api-specification.md]

**Task Update Endpoint:**
```typescript
// PATCH /api/tasks/[taskId]
interface UpdateTaskRequest {
  title?: string;
  description?: string;
  assigneeId?: string;
  dueDate?: string; // ISO date string
  status?: 'pending' | 'in_progress' | 'completed';
  version: number; // Optimistic locking version
}

interface UpdateTaskResponse {
  id: string;
  familyId: string;
  title: string;
  description?: string;
  assigneeId: string;
  createdById: string;
  dueDate?: string;
  completedAt?: string;
  status: 'pending' | 'in_progress' | 'completed';
  category: 'task' | 'event';
  priority: 'low' | 'medium' | 'high';
  syncVersion: number;
  createdAt: string;
  updatedAt: string;
}
```

**Component Architecture** [Source: docs/architecture/frontend-architecture.md]

**Task Status Management Components Structure:**
```
src/components/
├── task/
│   ├── TaskCard.tsx                   # Enhanced with status management UI
│   ├── TaskEditModal.tsx              # Task editing interface
│   ├── AssignmentTransfer.tsx         # Reassignment functionality  
│   ├── CompletionModal.tsx            # Completion confirmation with notes
│   └── TaskStatusIndicator.tsx        # Visual status display component
├── ui/
│   ├── Button.tsx                     # Action buttons for status changes
│   └── Modal.tsx                      # Base modal for editing and completion
└── family/
    └── FamilyMemberSelect.tsx         # Reused for reassignment
```

**State Management Pattern for Task Status Updates:** [Source: docs/architecture/frontend-architecture.md]
```typescript
// React Query mutation for task status updates
export const useUpdateTask = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: (update: { taskId: string; updates: Partial<Task> }) => 
      taskService.updateTask(update.taskId, update.updates),
    onMutate: async ({ taskId, updates }) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['tasks'] });
      
      // Snapshot previous value
      const previousTasks = queryClient.getQueryData(['tasks']);
      
      // Optimistically update cache
      queryClient.setQueryData(['tasks'], (old: Task[] = []) =>
        old.map(task => 
          task.id === taskId 
            ? { ...task, ...updates, updatedAt: new Date() }
            : task
        )
      );
      
      return { previousTasks };
    },
    onError: (err, { taskId }, context) => {
      queryClient.setQueryData(['tasks'], context?.previousTasks);
    },
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['tasks'] });
    },
  });
};
```

**File Locations Based on Project Structure** [Source: docs/architecture/unified-project-structure.md]
```
src/
├── app/api/tasks/[taskId]/route.ts    # Task update API endpoint
├── components/task/                   # Task status management components
│   ├── TaskCard.tsx                   # Enhanced existing component
│   ├── TaskEditModal.tsx
│   ├── AssignmentTransfer.tsx
│   ├── CompletionModal.tsx
│   └── TaskStatusIndicator.tsx
├── hooks/
│   └── useUpdateTask.ts               # Task update mutation hook
├── lib/
│   ├── validation.ts                  # Task update validation schemas
│   └── supabase.ts                    # Database client with real-time
└── types/
    └── task.ts                        # Task-related TypeScript interfaces
```

**Real-time Updates Integration** [Source: docs/architecture/api-specification.md]
- Supabase real-time subscriptions for immediate status change visibility
- WebSocket-based updates broadcasted to all family members
- Optimistic UI updates with proper rollback on conflicts
- Conflict resolution using syncVersion for concurrent edits

**Family Data Isolation** [Source: docs/architecture/data-models.md]
- All task updates must include family ID filtering from authenticated user context
- Family member reassignment validation ensures only family members can be assigned tasks
- RLS policies on Supabase prevent cross-family task access
- API middleware enforces family membership validation for all updates

**Mobile-First Design Requirements** [Source: docs/architecture/frontend-architecture.md]
- Touch targets minimum 44px for accessibility compliance
- Status buttons optimized for mobile interaction with appropriate spacing
- Edit modals designed for mobile viewport with touch-friendly controls
- Visual status indicators clear and distinguishable on small screens
- Completion actions easily accessible with thumb-reachable positioning

**Security Considerations** [Source: docs/architecture/coding-standards.md]
- Never expose family IDs in client-side code - derive from authenticated user
- Validate all task update inputs server-side with proper sanitization
- Implement rate limiting for task update API endpoints
- Use proper CSRF protection for form submissions
- Sanitize task titles and descriptions to prevent XSS attacks
- Validate assignment changes to ensure only family members can be assigned

### Testing Requirements

**Test Organization** [Source: docs/architecture/testing-strategy.md]
```
src/__tests__/
├── components/task/
│   ├── TaskCard.test.tsx              # Enhanced status management tests
│   ├── TaskEditModal.test.tsx         # Task editing form tests
│   ├── AssignmentTransfer.test.tsx    # Reassignment functionality tests
│   ├── CompletionModal.test.tsx       # Completion workflow tests
│   └── TaskStatusIndicator.test.tsx   # Status display component tests
├── hooks/
│   └── useUpdateTask.test.ts          # Task update hook tests
├── api/
│   └── tasks/[taskId].test.ts         # API endpoint tests for updates
└── fixtures/
    ├── tasks.json                     # Test task data with various statuses
    └── taskUpdates.json               # Test update scenarios
```

**Required Test Coverage:**
- Component rendering with different task statuses and states
- Status update interactions with immediate visual feedback
- Task editing form validation with valid and invalid inputs
- Assignment transfer with family member validation
- Completion confirmation workflow with optional notes
- API endpoint with family data isolation and conflict resolution validation
- Error handling for failed task updates and network issues
- Optimistic updates and rollback scenarios
- Real-time update integration and family member visibility
- Accessibility compliance for status indicators and action buttons
- Mobile responsive behavior across different viewport sizes

**Testing Patterns for Task Status Management:**
```typescript
// Component test example
describe('TaskCard Status Management', () => {
  it('completes task with one tap and shows immediate feedback', async () => {
    const mockUpdateTask = jest.fn().mockResolvedValue({...mockTask, status: 'completed'});
    const onUpdate = jest.fn();
    
    render(<TaskCard task={mockPendingTask} onUpdate={onUpdate} />, { 
      wrapper: createTestWrapper() 
    });
    
    const completeButton = screen.getByLabelText(/mark as complete/i);
    await userEvent.click(completeButton);
    
    // Verify immediate UI feedback
    expect(screen.getByTestId('task-card')).toHaveClass('opacity-60');
    expect(mockUpdateTask).toHaveBeenCalledWith({
      taskId: mockPendingTask.id,
      updates: { status: 'completed', completedAt: expect.any(Date) }
    });
  });

  it('shows status indicators with correct visual design', () => {
    const pendingTask = { ...mockTask, status: 'pending' };
    const inProgressTask = { ...mockTask, status: 'in_progress' };
    const completedTask = { ...mockTask, status: 'completed' };
    
    const { rerender } = render(<TaskCard task={pendingTask} />);
    expect(screen.getByTestId('status-indicator')).toHaveClass('bg-gray-100');
    
    rerender(<TaskCard task={inProgressTask} />);
    expect(screen.getByTestId('status-indicator')).toHaveClass('bg-blue-100');
    
    rerender(<TaskCard task={completedTask} />);
    expect(screen.getByTestId('status-indicator')).toHaveClass('bg-green-100');
  });
});

// API test example
describe('PATCH /api/tasks/[taskId]', () => {
  it('updates task status with family isolation and optimistic locking', async () => {
    const response = await request(app)
      .patch(`/api/tasks/${testTask.id}`)
      .set('Authorization', `Bearer ${authToken}`)
      .send({
        status: 'completed',
        version: testTask.syncVersion
      })
      .expect(200);
      
    expect(response.body).toMatchObject({
      id: testTask.id,
      status: 'completed',
      completedAt: expect.any(String),
      syncVersion: testTask.syncVersion + 1,
      familyId: testUser.familyId
    });
  });

  it('prevents task update with version conflict (409)', async () => {
    await request(app)
      .patch(`/api/tasks/${testTask.id}`)
      .set('Authorization', `Bearer ${authToken}`)
      .send({
        status: 'completed',
        version: testTask.syncVersion - 1 // Old version
      })
      .expect(409);
  });

  it('prevents cross-family task updates', async () => {
    await request(app)
      .patch(`/api/tasks/${otherFamilyTask.id}`)
      .set('Authorization', `Bearer ${authToken}`)
      .send({
        status: 'completed',
        version: otherFamilyTask.syncVersion
      })
      .expect(404); // Should not find task due to RLS
  });
});
```

**Performance Testing Requirements:**
- Task status updates should complete within 1 second on 3G mobile connections
- Optimistic UI updates should be immediate (< 100ms)
- Real-time updates should propagate to family members within 2 seconds
- Edit modals should open and close smoothly at 60fps
- Task list should handle status changes without noticeable re-rendering lag

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-05 | 1.0 | Initial story creation with comprehensive architecture context and full-stack implementation plan | Sarah (Product Owner) |