# <!-- Powered by BMADâ„¢ Core -->

# Story 2.2: Task Status Management and Completion

## Status
âœ… **UNBLOCKED - READY FOR DEVELOPMENT** - 2025-09-04

**ISSUE RESOLVED:** Story 1.2 authentication system has been fully implemented and Epic 1 is now functionally complete. Epic 2 development can proceed with confidence that users can authenticate and access family coordination features.

## Story
**As a** family member,  
**I want** to easily update task status and mark items complete,  
**so that** my family can see real-time progress on shared responsibilities.

## Acceptance Criteria

1. **One-tap task completion** with immediate visual feedback and status update
2. **Task status indicators** showing pending, in-progress, and completed states with clear visual design
3. **Assignment transfer** allowing tasks to be reassigned between family members
4. **Task editing capability** for title, due date, and assignment changes after creation
5. **Completion confirmation** with optional notes or comments for complex tasks
6. **Status change visibility** immediately reflected in all family members' views

## Tasks / Subtasks

- [ ] Implement one-tap task completion functionality (AC: 1)
  - [ ] Add completion button to TaskCard component with touch-friendly sizing
  - [ ] Implement optimistic UI update with immediate visual feedback
  - [ ] Create completion animation and status transition effects
  - [ ] Add undo completion capability with 3-second toast notification
  - [ ] Ensure completion only available for assigned family members
- [ ] Build comprehensive task status indicator system (AC: 2)
  - [ ] Design and implement visual states for pending, in-progress, completed
  - [ ] Create TaskStatusBadge component with color coding and icons
  - [ ] Add status transition animations between states
  - [ ] Implement status filtering in weekly view (pending, in-progress, completed)
  - [ ] Add status legend or help for family members
- [ ] Implement task reassignment functionality (AC: 3)
  - [ ] Create TaskReassignModal with family member selection
  - [ ] Add reassign action to TaskCard dropdown/context menu
  - [ ] Implement family member validation and permission checks
  - [ ] Create notification system for reassignment updates
  - [ ] Add reassignment history tracking in task data
- [ ] Build comprehensive task editing interface (AC: 4)
  - [ ] Create TaskEditModal with form pre-populated with current values
  - [ ] Implement inline editing for task title with auto-save
  - [ ] Add due date modification with calendar picker integration
  - [ ] Create assignment change interface within edit modal
  - [ ] Add form validation and conflict detection for concurrent edits
- [ ] Implement completion confirmation system (AC: 5)
  - [ ] Create CompletionModal for tasks requiring notes/confirmation
  - [ ] Add optional completion notes field with character limit
  - [ ] Implement completion photo/attachment capability (future extension)
  - [ ] Create confirmation requirements based on task type or priority
  - [ ] Add completion summary view for family review
- [ ] Set up real-time status change synchronization (AC: 6)
  - [ ] Implement WebSocket connections for real-time family updates
  - [ ] Create status change broadcast system across family members
  - [ ] Add optimistic updates with rollback on sync failures
  - [ ] Implement conflict resolution for simultaneous status changes
  - [ ] Add offline queueing for status changes with background sync
- [ ] Create comprehensive task status management API endpoints
  - [ ] Implement PATCH /api/tasks/:id/status endpoint with validation
  - [ ] Create task reassignment API with family member verification
  - [ ] Add task editing API with optimistic locking and sync conflict resolution
  - [ ] Implement completion notes storage and retrieval endpoints
  - [ ] Add real-time notification system for status changes
- [ ] Build comprehensive testing suite for task status management
  - [ ] Unit tests for TaskStatusBadge and completion functionality
  - [ ] Integration tests for real-time status updates across family members
  - [ ] API endpoint tests for status changes and reassignment validation
  - [ ] E2E tests for complete task management workflow
  - [ ] Accessibility tests for status indicators and completion interactions

## Dev Notes

### Previous Story Insights
Story 2.1 (Task Creation and Basic Management) established the foundation for task creation with comprehensive React Query + Zustand state management, optimistic updates, and family data isolation patterns. The existing TaskCard component and useFamilyTasks hook provide the base architecture for status management. The QuickAddModal pattern and API validation approach should be extended for task editing and status management functionality.

### Architecture Context

**Core Technology Stack** [Source: architecture/tech-stack.md]
- Frontend Framework: Next.js 14.2+ with App Router for API routes and real-time capabilities
- UI Framework: Custom components with Tailwind CSS 3.4+ for mobile-first responsive design  
- State Management: React Query 5.0+ for server state with optimistic updates, Zustand 4.4+ for client UI state
- Database: Supabase PostgreSQL with real-time subscriptions for family coordination
- TypeScript: 5.2+ for type safety across components and API calls
- Real-time: WebSocket connections for instant family status updates
- Testing: Jest + React Testing Library for components, Playwright for E2E testing

**Data Models for Task Status Management** [Source: architecture/data-models.md]

**Task Interface with Status Management:**
```typescript
interface Task {
  id: string;
  familyId: string;
  title: string;
  description?: string;
  assigneeId: string;
  createdById: string;
  dueDate?: Date;
  completedAt?: Date;
  status: 'pending' | 'in_progress' | 'completed';
  category: 'task' | 'event';
  priority: 'low' | 'medium' | 'high';
  createdAt: Date;
  updatedAt: Date;
  syncVersion: number; // Critical for conflict resolution
  completionNotes?: string;
  reassignmentHistory?: TaskReassignment[];
}

interface TaskReassignment {
  fromAssigneeId: string;
  toAssigneeId: string;
  reassignedById: string;
  reassignedAt: Date;
  reason?: string;
}

interface UpdateTaskStatusInput {
  status: 'pending' | 'in_progress' | 'completed';
  completedAt?: Date;
  completionNotes?: string;
  syncVersion: number;
}

interface ReassignTaskInput {
  newAssigneeId: string;
  reason?: string;
  syncVersion: number;
}
```

**API Specifications for Status Management** [Source: architecture/backend-architecture.md]

**Task Status Update Endpoint:**
```typescript
// PATCH /api/tasks/:id/status
interface UpdateTaskStatusRequest {
  status: 'pending' | 'in_progress' | 'completed';
  completedAt?: string; // ISO date string
  completionNotes?: string;
  syncVersion: number;
}

interface TaskStatusResponse {
  id: string;
  status: 'pending' | 'in_progress' | 'completed';
  completedAt?: string;
  syncVersion: number;
  updatedAt: string;
}

// PATCH /api/tasks/:id/reassign
interface ReassignTaskRequest {
  newAssigneeId: string;
  reason?: string;
  syncVersion: number;
}

// PATCH /api/tasks/:id
interface EditTaskRequest {
  title?: string;
  description?: string;
  dueDate?: string;
  assigneeId?: string;
  priority?: 'low' | 'medium' | 'high';
  syncVersion: number;
}
```

**Component Architecture for Status Management** [Source: architecture/frontend-architecture.md]

**Status Management Components Structure:**
```
src/components/
â”œâ”€â”€ task/
â”‚   â”œâ”€â”€ TaskCard.tsx                    # Extended with status indicators and actions
â”‚   â”œâ”€â”€ TaskStatusBadge.tsx             # Visual status indicator component
â”‚   â”œâ”€â”€ TaskReassignModal.tsx           # Task reassignment interface
â”‚   â”œâ”€â”€ TaskEditModal.tsx               # Comprehensive task editing
â”‚   â”œâ”€â”€ CompletionModal.tsx             # Task completion confirmation
â”‚   â””â”€â”€ TaskActionsDropdown.tsx         # Context menu for task actions
â””â”€â”€ ui/
    â”œâ”€â”€ StatusIndicator.tsx             # Base status component
    â”œâ”€â”€ ConfirmationDialog.tsx          # Reusable confirmation component
    â””â”€â”€ Toast.tsx                       # Toast notifications for actions
```

**State Management Pattern for Status Updates:**
```typescript
// React Query mutations for status management
export const useUpdateTaskStatus = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: ({ taskId, status, syncVersion }: { 
      taskId: string; 
      status: TaskStatus; 
      syncVersion: number; 
    }) => taskService.updateTaskStatus(taskId, status, syncVersion),
    
    onMutate: async ({ taskId, status }) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['tasks'] });
      
      // Snapshot previous value
      const previousTasks = queryClient.getQueryData(['tasks']);
      
      // Optimistically update cache
      queryClient.setQueryData(['tasks'], (old: Task[] = []) =>
        old.map(task => 
          task.id === taskId 
            ? { 
                ...task, 
                status, 
                completedAt: status === 'completed' ? new Date() : undefined,
                syncVersion: task.syncVersion + 1 
              }
            : task
        )
      );
      
      return { previousTasks };
    },
    
    onError: (err, variables, context) => {
      // Handle sync conflicts
      if (err.response?.status === 409) {
        // Show conflict resolution UI
        const latestTask = err.response.data.latestVersion;
        showSyncConflictDialog(latestTask);
      } else {
        // Rollback on other errors
        queryClient.setQueryData(['tasks'], context?.previousTasks);
      }
    },
    
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['tasks'] });
    },
  });
};

// Zustand store for status management UI state
interface TaskStatusStore {
  editingTaskId?: string;
  reassignTaskId?: string;
  completingTaskId?: string;
  syncConflictTask?: Task;
  
  setEditingTask: (taskId?: string) => void;
  setReassignTask: (taskId?: string) => void;
  setCompletingTask: (taskId?: string) => void;
  setSyncConflictTask: (task?: Task) => void;
}
```

**Real-time Updates Architecture** [Source: architecture/core-workflows.md]

**WebSocket Integration for Family Coordination:**
```typescript
// Real-time status updates using Supabase subscriptions
export const useTaskStatusSubscription = (familyId: string) => {
  const queryClient = useQueryClient();
  
  useEffect(() => {
    const subscription = supabase
      .channel('task_status_changes')
      .on('postgres_changes', 
        { 
          event: 'UPDATE', 
          schema: 'public', 
          table: 'tasks',
          filter: `family_id=eq.${familyId}` 
        },
        (payload) => {
          const updatedTask = payload.new as Task;
          
          // Update React Query cache immediately
          queryClient.setQueryData(['tasks'], (old: Task[] = []) =>
            old.map(task => 
              task.id === updatedTask.id ? updatedTask : task
            )
          );
          
          // Show notification for status changes by other family members
          if (updatedTask.assigneeId !== currentUser.id) {
            showTaskStatusNotification(updatedTask);
          }
        }
      )
      .subscribe();
      
    return () => {
      subscription.unsubscribe();
    };
  }, [familyId, queryClient]);
};
```

**File Locations Based on Project Structure** [Source: current project structure]
```
src/
â”œâ”€â”€ app/api/tasks/
â”‚   â”œâ”€â”€ [id]/
â”‚   â”‚   â”œâ”€â”€ status/route.ts           # Task status update endpoint
â”‚   â”‚   â”œâ”€â”€ reassign/route.ts         # Task reassignment endpoint
â”‚   â”‚   â””â”€â”€ route.ts                  # Task editing endpoint (PATCH)
â”œâ”€â”€ components/task/                  # Status management components
â”‚   â”œâ”€â”€ TaskCard.tsx                  # Extended with status actions
â”‚   â”œâ”€â”€ TaskStatusBadge.tsx          # Status indicator component
â”‚   â”œâ”€â”€ TaskReassignModal.tsx        # Reassignment interface
â”‚   â”œâ”€â”€ TaskEditModal.tsx            # Task editing modal
â”‚   â”œâ”€â”€ CompletionModal.tsx          # Completion confirmation
â”‚   â””â”€â”€ TaskActionsDropdown.tsx      # Context menu
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useUpdateTaskStatus.ts       # Status update mutation
â”‚   â”œâ”€â”€ useReassignTask.ts           # Reassignment mutation
â”‚   â”œâ”€â”€ useEditTask.ts               # Task editing mutation
â”‚   â””â”€â”€ useTaskStatusSubscription.ts # Real-time status updates
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ task-service.ts              # Extended with status operations
â”‚   â””â”€â”€ validation.ts                # Status validation schemas
â””â”€â”€ types/
    â””â”€â”€ task.ts                      # Extended task interfaces
```

**Core Workflows for Task Status Management** [Source: architecture/core-workflows.md]

**Task Status Update Workflow:**
1. User taps status indicator or completion button on TaskCard
2. Optimistic UI update shows immediate status change with visual feedback
3. If completion requires confirmation, show CompletionModal with notes field
4. Submit status update to API with current syncVersion for conflict detection
5. Handle sync conflicts by showing resolution options to user
6. Broadcast status change to other family members via WebSocket
7. Show success animation and update local cache
8. Queue status change for offline sync if network unavailable

**Task Reassignment Workflow:**
1. User opens task actions dropdown and selects "Reassign"
2. TaskReassignModal opens with family member selection
3. User selects new assignee and optional reason for reassignment
4. Validate new assignee is active family member
5. Submit reassignment with family data isolation validation
6. Update task assignment and add to reassignment history
7. Notify previous and new assignee of reassignment
8. Update UI across all family members' views

**Family Data Isolation for Status Management** [Source: architecture/coding-standards.md]
- All status updates must validate family membership of user and task
- Task reassignment restricted to family members only
- Status change notifications sent only to family members
- Sync conflicts resolved within family context only
- API endpoints enforce family data isolation at middleware level

**Mobile-First Design for Status Management** [Source: architecture/frontend-architecture.md]
- Status indicators minimum 44px touch targets for accessibility
- One-tap completion with immediate visual feedback
- Swipe gestures for quick status changes (future enhancement)
- Task editing optimized for mobile keyboards and inputs
- Status change animations optimized for 60fps mobile performance

**Security Considerations for Status Management** [Source: architecture/coding-standards.md]
- Validate user permissions for task status changes (only assignee can complete)
- Sanitize completion notes and reassignment reasons to prevent XSS
- Implement rate limiting for status change API endpoints
- Log all status changes for audit trail and family coordination history
- Validate syncVersion to prevent concurrent modification conflicts

### Testing Requirements

**Test Organization** [Source: architecture/testing-strategy.md]
```
src/__tests__/
â”œâ”€â”€ components/task/
â”‚   â”œâ”€â”€ TaskStatusBadge.test.tsx      # Status indicator tests
â”‚   â”œâ”€â”€ TaskReassignModal.test.tsx    # Reassignment interface tests
â”‚   â”œâ”€â”€ TaskEditModal.test.tsx        # Task editing tests
â”‚   â”œâ”€â”€ CompletionModal.test.tsx      # Completion confirmation tests
â”‚   â””â”€â”€ TaskActionsDropdown.test.tsx  # Context menu tests
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useUpdateTaskStatus.test.ts   # Status update hook tests
â”‚   â”œâ”€â”€ useReassignTask.test.ts       # Reassignment hook tests
â”‚   â””â”€â”€ useTaskStatusSubscription.test.ts # Real-time updates tests
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ task-status.test.ts           # Status update API tests
â”‚   â”œâ”€â”€ task-reassign.test.ts         # Reassignment API tests
â”‚   â””â”€â”€ task-edit.test.ts             # Task editing API tests
â””â”€â”€ fixtures/
    â”œâ”€â”€ task-status-changes.json      # Status change test data
    â””â”€â”€ reassignments.json            # Reassignment test scenarios
```

**Required Test Coverage:**
- Component rendering with different status states and visual feedback
- Status update optimistic updates and rollback on errors
- Family member validation for reassignment and status changes
- Sync conflict resolution and concurrent modification handling
- Real-time status updates across multiple family members
- API endpoints with family data isolation and permission validation
- Offline status change queueing and background sync
- Task editing with form validation and conflict detection
- Completion confirmation flow with notes and validation
- Accessibility compliance for status indicators and actions

**Testing Patterns for Status Management:**
```typescript
// Component test example for status management
describe('TaskStatusBadge', () => {
  it('displays correct visual state for each status', () => {
    const statuses = ['pending', 'in_progress', 'completed'] as const;
    
    statuses.forEach(status => {
      render(<TaskStatusBadge status={status} />);
      
      const badge = screen.getByTestId('status-badge');
      expect(badge).toHaveClass(`status-${status}`);
      expect(badge).toHaveTextContent(statusLabels[status]);
    });
  });

  it('handles status transitions with animations', async () => {
    const mockOnStatusChange = jest.fn();
    
    render(
      <TaskStatusBadge 
        status="pending" 
        onStatusChange={mockOnStatusChange}
        editable
      />
    );
    
    await userEvent.click(screen.getByRole('button', { name: /mark in progress/i }));
    
    await waitFor(() => {
      expect(mockOnStatusChange).toHaveBeenCalledWith('in_progress');
    });
  });
});

// API test example for status management
describe('PATCH /api/tasks/:id/status', () => {
  it('updates task status with sync version validation', async () => {
    const task = await createTestTask({ status: 'pending', syncVersion: 1 });
    
    const response = await request(app)
      .patch(`/api/tasks/${task.id}/status`)
      .set('Authorization', `Bearer ${authToken}`)
      .send({
        status: 'completed',
        completedAt: new Date().toISOString(),
        syncVersion: 1
      })
      .expect(200);
      
    expect(response.body).toMatchObject({
      id: task.id,
      status: 'completed',
      completedAt: expect.any(String),
      syncVersion: 2
    });
  });

  it('handles sync conflicts correctly', async () => {
    const task = await createTestTask({ syncVersion: 2 });
    
    const response = await request(app)
      .patch(`/api/tasks/${task.id}/status`)
      .set('Authorization', `Bearer ${authToken}`)
      .send({
        status: 'completed',
        syncVersion: 1 // Outdated version
      })
      .expect(409);
      
    expect(response.body.error).toContain('Sync conflict detected');
    expect(response.body.latestVersion.syncVersion).toBe(2);
  });
});
```

**Performance Testing Requirements:**
- Status updates should complete within 500ms on 3G mobile connections
- Optimistic UI updates should be immediate (< 100ms)
- Real-time status broadcasts should reach family members within 2 seconds
- Status change animations should maintain 60fps on mobile devices
- Offline status changes should queue without blocking UI interactions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation with comprehensive status management architecture and real-time coordination requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

---

### IMPORTANT: Developer Branching Instructions

**ðŸš¨ CRITICAL: Use Feature Branch Development Workflow**

When implementing this story, developers MUST follow this branching strategy:

1. **Create Feature Branch**: 
   ```bash
   git checkout main
   git pull origin main
   git checkout -b feature/story-2.2-task-status-management
   ```

2. **Development Process**:
   - Work on the feature branch throughout story development
   - Make regular commits with descriptive messages
   - Push feature branch to remote regularly for backup

3. **Story Completion**:
   - When story is complete and all acceptance criteria are met
   - Create Pull Request from feature branch to main
   - Ensure all tests pass and code review is completed
   - Merge PR to main only when story is fully Done

4. **Branch Naming Convention**:
   - Use format: `feature/story-X.X-brief-description`
   - Example: `feature/story-2.2-task-status-management`

**Benefits of Feature Branch Workflow**:
- âœ… Keeps main branch stable and deployable
- âœ… Allows parallel development of multiple stories
- âœ… Enables proper code review process
- âœ… Provides clear story completion boundaries
- âœ… Facilitates rollback if needed

This ensures clean story boundaries and maintains a stable main branch for continuous deployment.