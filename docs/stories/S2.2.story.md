# <!-- Powered by BMAD™ Core -->

# Story S2.2: Dependency Modernization

## Status
⚠️ **IMPORTANT** - Not Started

## Story
**As a** developer,  
**I want** modern, supported dependencies and resolved compatibility issues,  
**so that** the project is maintainable, secure, and compatible with current tooling.

## Acceptance Criteria

1. **Replace deprecated Supabase auth helpers** with modern @supabase/ssr package
2. **Update code using old auth helpers API** to use new patterns
3. **Resolve Node.js version compatibility** warnings where possible
4. **Document Node.js version requirements** clearly in project documentation
5. **Verify all functionality works** with updated dependencies
6. **Minimize dependency warnings** and use supported package versions

## Tasks / Subtasks

- [ ] **Replace deprecated Supabase auth helpers** (AC: 1, 2)
  - [ ] Remove `@supabase/auth-helpers-nextjs` dependency
  - [ ] Install and configure `@supabase/ssr` package  
  - [ ] Update auth helper imports throughout codebase
  - [ ] Migrate createServerSupabaseClient to new SSR patterns
  - [ ] Update cookie handling to use new SSR methods
  - [ ] Test that authentication still works with new packages
- [ ] **Address Node.js version compatibility** (AC: 3, 4)
  - [ ] Document supported Node.js versions in README
  - [ ] Update package.json engines field if needed
  - [ ] Evaluate upgrading Jest dependencies to support Node.js v23
  - [ ] Add .nvmrc file for Node version consistency
  - [ ] Test application with recommended Node.js LTS version
- [ ] **Audit and update other dependencies** (AC: 6)
  - [ ] Review all dependency warnings in npm install output
  - [ ] Update packages with available newer versions
  - [ ] Check for security vulnerabilities with npm audit
  - [ ] Update TypeScript and related tooling if beneficial
  - [ ] Verify build tools work with updated dependencies
- [ ] **Test functionality with updated dependencies** (AC: 5)
  - [ ] Run full test suite with updated packages
  - [ ] Test authentication flow with new Supabase SSR
  - [ ] Verify build and development processes work
  - [ ] Test deployment process with updated dependencies
  - [ ] Confirm no regression in application functionality

## Dev Notes

### Current Dependency Issues

**Deprecated Packages:**
```bash
npm warn deprecated @supabase/auth-helpers-shared@0.7.0
npm warn deprecated @supabase/auth-helpers-nextjs@0.10.0
# Recommended: Use @supabase/ssr package instead
```

**Node.js Compatibility Warnings:**
```bash
# Jest packages require: '^18.14.0 || ^20.0.0 || ^22.0.0 || >=24.0.0'
# Current: v23.10.0 (not in supported range)
```

### Migration Strategy

**Supabase Auth Helpers → SSR Migration:**
```typescript
// Old pattern:
import { createServerSupabaseClient } from '@supabase/auth-helpers-nextjs'

// New pattern:
import { createServerClient } from '@supabase/ssr'
```

**Code Updates Required:**
- Update all auth helper imports
- Migrate server-side client creation
- Update cookie handling patterns
- Adjust middleware if using auth helpers there

### Architecture Impact

**Authentication System Changes:**
- Server-side client creation patterns
- Cookie management approaches
- Session handling methods
- Type definitions and interfaces

**Development Workflow:**
- Build process compatibility
- Testing framework compatibility
- Hot reload and development server stability

### Dependencies Analysis

**Critical Dependencies to Update:**
1. **@supabase/ssr**: Replace auth helpers with modern SSR approach
2. **Jest ecosystem**: Address Node.js v23 compatibility if possible
3. **Build tools**: Ensure compatibility with latest versions
4. **TypeScript**: Keep up to date for best developer experience

## Testing

### Test Location Standards
- Dependency tests: Verify functionality after updates
- Integration tests: Ensure auth flow works with new packages
- Build tests: Confirm all processes work with updated deps

### Migration Testing Strategy
```typescript
// Test patterns for dependency updates:
describe('Supabase SSR Migration', () => {
  test('server client creation works', () => {
    // Test new createServerClient approach
  });
  
  test('authentication flow unchanged', () => {
    // Verify login/logout still work
  });
  
  test('cookie handling works', () => {
    // Test session persistence
  });
});
```

### Verification Checklist
- [ ] All tests pass with updated dependencies
- [ ] Build process completes successfully
- [ ] Development server starts without errors
- [ ] Authentication flow works exactly as before
- [ ] No new console warnings or errors
- [ ] Production deployment process unaffected

## Security Considerations

### Dependency Security
- [ ] Run `npm audit` to check for vulnerabilities
- [ ] Verify new packages come from trusted sources
- [ ] Ensure authentication security is maintained
- [ ] Check that new SSR patterns maintain security standards

### Compatibility Testing
- [ ] Test in multiple Node.js versions if possible
- [ ] Verify browser compatibility unchanged
- [ ] Confirm mobile functionality unaffected
- [ ] Test across different deployment environments

## Documentation Updates

### README Updates Required
- [ ] Update Node.js version requirements
- [ ] Document new dependency patterns
- [ ] Update setup instructions if changed
- [ ] Add troubleshooting for common issues

### Development Documentation
- [ ] Update authentication setup docs
- [ ] Document new Supabase SSR patterns
- [ ] Add migration notes for other developers
- [ ] Update CI/CD instructions if affected

## Definition of Done

**✅ Before moving this story to "Ready for Review", the developer MUST verify:**

### Code Quality Gates
- [ ] **Linter passes**: `npm run lint` completes with 0 errors and 0 warnings
- [ ] **Type check passes**: `npm run type-check` completes with 0 errors
- [ ] **Build succeeds**: `npm run build` completes successfully without errors
- [ ] **Dependency audit clean**: `npm audit` shows no critical vulnerabilities

### Dependency Migration Requirements
- [ ] **Deprecated packages removed**: All `@supabase/auth-helpers-*` packages uninstalled
- [ ] **Modern packages installed**: `@supabase/ssr` properly configured
- [ ] **Code migration complete**: All auth helper imports updated to SSR patterns
- [ ] **Functionality maintained**: Authentication works exactly as before
- [ ] **No breaking changes**: Existing auth flow unaffected by migration

### Testing Requirements
- [ ] **Migration tests pass**: All auth-related tests pass with new dependencies
- [ ] **Regression testing**: Complete authentication flow tested with new packages
- [ ] **Build compatibility**: All build processes work with updated dependencies
- [ ] **Development server**: Hot reload and dev tools work with new packages

### Deployment Verification
- [ ] **Preview deployment**: Updated dependencies deploy successfully to preview
- [ ] **Smoke test subset**: Run dependency-focused tests on preview:
  ```bash
  # Must pass on preview deployment:
  npx playwright test --grep="authentication|build|dependencies"
  ```
- [ ] **Performance check**: No performance regression with updated dependencies
- [ ] **SSR functionality**: Server-side rendering works correctly with new auth patterns

### Documentation Compliance
- [ ] **README updated**: Node.js version requirements documented clearly
- [ ] **Setup instructions**: Installation steps updated for new dependencies
- [ ] **Migration guide**: Notes for other developers on dependency changes
- [ ] **Environment setup**: Any new environment variables documented

### Version Compatibility
- [ ] **Node.js compatibility**: Documented supported Node.js versions
- [ ] **Package versions**: All dependencies use supported, non-deprecated versions
- [ ] **Lock file updated**: package-lock.json reflects new dependency tree
- [ ] **CI compatibility**: Build processes work in CI environment

### Git Workflow Requirements
- [ ] **Feature branch**: Work completed on feature branch (e.g., `feature/S2.2-dependency-modernization`)
- [ ] **Atomic commits**: Each commit represents a single logical change with clear message
- [ ] **Commit message format**: Follow conventional commits (e.g., `chore: migrate from auth-helpers to SSR package`)
- [ ] **No direct main commits**: All changes via pull request, never commit directly to main
- [ ] **Clean git history**: Squash/rebase commits if needed for clean history
- [ ] **Pre-commit hooks**: All pre-commit checks pass before each commit
- [ ] **Branch up to date**: Feature branch rebased/merged with latest main before PR
- [ ] **Dependency changes clear**: Separate commits for package.json and code changes
- [ ] **Lock file committed**: Updated package-lock.json committed with dependency changes
- [ ] **No breaking changes**: Dependency updates maintain backward compatibility
- [ ] **Documentation updates**: Commit any README or setup instruction changes
- [ ] **Git status clean**: `git status` shows clean working directory before PR
- [ ] **Descriptive PR**: Pull request has clear title, description, migration notes, and links to story

**⚡ PARALLEL WORK**: Can run parallel with S2.1 - coordinate to avoid auth testing conflicts.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-10 | 1.0 | Initial dependency modernization story | BMad Orchestrator |

## Priority Classification

**Epic**: Project Stabilization  
**Phase**: 2 - Foundation Improvements  
**Priority**: P1 - Important  
**Estimated Effort**: 2-3 hours  
**Assigned Agent**: `devops` specialist  
**Risk**: Medium - Dependency changes can introduce issues  
**Dependencies**: Can run parallel to S2.1