# <!-- Powered by BMAD™ Core -->

# Story 1.3: Database Schema and Models

## Status
Draft

## Story
**As a** developer,  
**I want** to implement comprehensive database migrations, TypeScript interfaces, and Supabase Row Level Security policies for Family, FamilyMember, Task, and Event data models,  
**so that** the application has a solid data foundation with proper security isolation and type safety for all family coordination features.

## Acceptance Criteria

1. **Supabase database schema** created with all tables (families, family_members, tasks, events, sync_logs) with proper relationships and constraints
2. **Row Level Security (RLS) policies** implemented for complete family data isolation across all tables
3. **TypeScript interfaces** defined and shared for all data models with proper type safety
4. **Database migrations** structured for version control and deployment consistency
5. **Performance indexes** created for optimal query performance on weekly dashboard operations
6. **Data validation** implemented at both database and TypeScript interface levels

## Tasks / Subtasks

- [ ] Create Supabase database schema with all required tables (AC: 1)
  - [ ] Set up families table with invite codes and settings JSON
  - [ ] Create family_members table with role-based permissions and avatar colors  
  - [ ] Implement tasks table with sync versioning and family relationships
  - [ ] Add events table with time-specific coordination features
  - [ ] Create sync_logs table for offline conflict resolution audit trail
  - [ ] Add all foreign key relationships and cascading delete constraints
- [ ] Implement Row Level Security policies for family data isolation (AC: 2)
  - [ ] Create RLS policies for families table (family members can only access their own family)
  - [ ] Implement family_members RLS policies (users can only see their family members)
  - [ ] Add tasks RLS policies (family members can only access family tasks)
  - [ ] Create events RLS policies (family members can only access family events)
  - [ ] Implement sync_logs RLS policies (family-scoped audit access only)
  - [ ] Test RLS policies to ensure complete cross-family data isolation
- [ ] Define comprehensive TypeScript interfaces for all data models (AC: 3)
  - [ ] Create Family interface with settings type definitions
  - [ ] Implement FamilyMember interface with role enums and validation
  - [ ] Define Task interface with status enums and sync versioning
  - [ ] Create Event interface with scheduling and location properties  
  - [ ] Add SyncLog interface for conflict resolution tracking
  - [ ] Create database input/output type definitions for all CRUD operations
- [ ] Structure database migrations for version control (AC: 4)
  - [ ] Create initial migration with all table definitions
  - [ ] Add migration for performance indexes and triggers
  - [ ] Implement RLS policy migration scripts
  - [ ] Create rollback migrations for all schema changes
  - [ ] Add migration execution scripts for deployment pipeline
- [ ] Create performance indexes for weekly dashboard queries (AC: 5)  
  - [ ] Add composite indexes for tasks by family and due date
  - [ ] Create indexes for assignee-based task filtering
  - [ ] Implement events indexes for start date and family queries
  - [ ] Add family member lookup indexes for performance
  - [ ] Create sync log indexes for conflict resolution queries
- [ ] Implement data validation at database and TypeScript levels (AC: 6)
  - [ ] Add CHECK constraints for enums (role, status, priority, category)
  - [ ] Create validation triggers for data integrity
  - [ ] Implement TypeScript schema validation with Zod
  - [ ] Add email format validation and unique constraints
  - [ ] Create date validation for task due dates and event scheduling
- [ ] Create comprehensive database testing suite
  - [ ] Unit tests for all TypeScript interfaces and validation
  - [ ] Integration tests for RLS policy enforcement
  - [ ] Performance tests for indexed queries
  - [ ] Migration tests for schema version control
  - [ ] Data integrity tests for all constraints and relationships

## Dev Notes

### Previous Story Insights
Stories 1.1 and 1.2 are currently in Draft status. This database schema story is designed for parallel development and can work on a separate Supabase instance. The schema and TypeScript interfaces created here will be essential for the authentication system (1.2) and family management features.

### Architecture Context

**Core Technology Stack** [Source: architecture/tech-stack.md]
- Database Service: Supabase PostgreSQL with real-time capabilities and built-in Row Level Security
- Frontend Language: TypeScript 5.2+ for type safety across components and API calls
- Backend Framework: Next.js API Routes 14.2+ (serverless functions integrated with frontend)
- State Management: React Query 5.0+ for server state with Supabase integration
- Authentication: Supabase Auth with JWT tokens for automatic RLS integration

**Data Models** [Source: architecture/data-models.md]

**Family Model:**
- Core coordination unit with shared access to tasks and events
- id: string (UUID), name: string, createdAt/updatedAt: Date
- inviteCode: string for secure family member joining
- settings: JSON with weekStartDay ('sunday'|'monday'), timezone, notifications config

**FamilyMember Model:**
- Individual user account within family context for task assignment
- id: string (UUID), familyId: string, email: string (unique), name: string
- role: 'admin'|'member' for family management permissions
- avatarColor: string for consistent visual identification per front-end spec
- passwordHash: string (managed by Supabase Auth), isActive: boolean
- createdAt, updatedAt, lastSeenAt: Date for audit trail

**Task Model:**
- Core coordination entity with assignment, due dates, completion tracking
- id: string (UUID), familyId: string, title: string, description?: string
- assigneeId: string, createdById: string for ownership tracking
- dueDate?: Date, completedAt?: Date, status: 'pending'|'in_progress'|'completed'
- category: 'task'|'event', priority: 'low'|'medium'|'high'
- syncVersion: number for offline conflict resolution

**Event Model:**  
- Time-specific family coordination with scheduling integration
- id: string (UUID), familyId: string, title: string, description?: string
- assigneeId: string, createdById: string, location?: string
- startDateTime: Date, endDateTime: Date for duration calculation
- status: 'scheduled'|'in_progress'|'completed'|'cancelled'
- syncVersion: number for offline conflict resolution

**Database Schema Implementation** [Source: architecture/database-schema.md]

```sql
-- Core tables with proper relationships and constraints
CREATE TABLE families (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    invite_code TEXT UNIQUE NOT NULL, 
    settings JSON NOT NULL DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE family_members (
    id TEXT PRIMARY KEY,
    family_id TEXT NOT NULL REFERENCES families(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    name TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('admin', 'member')),
    avatar_color TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_seen_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    family_id TEXT NOT NULL REFERENCES families(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    assignee_id TEXT NOT NULL REFERENCES family_members(id) ON DELETE CASCADE,
    created_by_id TEXT NOT NULL REFERENCES family_members(id) ON DELETE CASCADE,
    due_date TIMESTAMP,
    completed_at TIMESTAMP,
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed')),
    category TEXT NOT NULL DEFAULT 'task' CHECK (category IN ('task', 'event')),
    priority TEXT NOT NULL DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high')),
    sync_version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE events (
    id TEXT PRIMARY KEY,
    family_id TEXT NOT NULL REFERENCES families(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    assignee_id TEXT NOT NULL REFERENCES family_members(id) ON DELETE CASCADE,
    created_by_id TEXT NOT NULL REFERENCES family_members(id) ON DELETE CASCADE,
    start_datetime TIMESTAMP NOT NULL,
    end_datetime TIMESTAMP NOT NULL,
    location TEXT,
    status TEXT NOT NULL DEFAULT 'scheduled' CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled')),
    sync_version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**Performance Indexes** [Source: architecture/database-schema.md]
- Tasks: idx_tasks_family_due_date, idx_tasks_assignee, idx_tasks_status
- Events: idx_events_family_start_date, idx_events_assignee  
- Family Members: idx_family_members_family, idx_family_members_email
- Composite indexes for weekly dashboard queries: tasks(family_id, due_date), events(family_id, start_datetime)

**Row Level Security Policies** [Source: architecture/backend-architecture.md]
- All tables must implement RLS policies ensuring family data isolation
- Users can only access records where family_id matches their authenticated family membership
- Admin role permissions for family management operations
- RLS policies must be tested to prevent cross-family data leaks

**Project Structure** [Source: architecture/unified-project-structure.md]
```
project-root/
├── supabase/
│   ├── migrations/          # Database migration files
│   │   ├── 20240101000000_initial_schema.sql
│   │   ├── 20240101000001_rls_policies.sql  
│   │   └── 20240101000002_indexes.sql
│   └── config.toml         # Supabase configuration
├── src/
│   ├── types/              # TypeScript interfaces
│   │   ├── database.ts     # Database table types
│   │   ├── family.ts       # Family-related types
│   │   ├── task.ts         # Task and event types
│   │   └── index.ts        # Type exports
│   └── lib/
│       ├── supabase.ts     # Supabase client configuration
│       └── validations.ts  # Zod schemas for data validation
```

**Critical Implementation Requirements** [Source: architecture/coding-standards.md]
- Type Sharing: Define all interfaces in shared location for frontend/backend consistency
- Family Data Isolation: Every query must enforce family ID filtering at database level
- Security Headers: RLS policies are mandatory for all family-scoped data
- Environment Variables: Supabase connection configured through environment variables only

### Testing Requirements

**Test Organization** [Source: architecture/testing-strategy.md]
```
tests/
├── __tests__/              # Jest unit tests
│   ├── types/              # TypeScript interface validation tests
│   ├── database/           # Database schema and RLS policy tests
│   │   ├── migrations.test.ts
│   │   ├── rls-policies.test.ts
│   │   └── schema-validation.test.ts
│   └── lib/                # Supabase client and validation tests
└── fixtures/               # Test data for database seeding
    ├── families.json
    ├── family-members.json
    └── tasks-events.json
```

**Testing Standards:**
- Database Tests: Jest + Supabase Test Client for schema validation and RLS testing
- Type Tests: Jest + TypeScript compiler for interface validation
- Migration Tests: Test both forward and rollback migrations
- RLS Policy Tests: Verify family data isolation with multiple test families
- Performance Tests: Validate index performance with realistic data volumes

**Required Test Coverage:**
- All TypeScript interfaces compile without errors
- Database schema creation and migration scripts execute successfully
- RLS policies prevent cross-family data access (critical security test)
- All indexes improve query performance for weekly dashboard operations
- Data validation prevents invalid data at both TypeScript and database levels
- Migration rollback scripts restore previous schema versions correctly

### Security and Performance Considerations

**Row Level Security Implementation** [Source: architecture/backend-architecture.md]
- Enable RLS on all tables: `ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;`
- Create family isolation policies: `CREATE POLICY family_isolation ON table_name FOR ALL TO authenticated USING (family_id = auth.jwt() ->> 'family_id');`
- Test RLS policies with multiple family contexts to ensure complete isolation
- Supabase Auth integration provides automatic family_id in JWT payload

**Database Performance** [Source: architecture/database-schema.md]
- Composite indexes for weekly dashboard queries (family_id + date columns)
- Single column indexes for assignee and status filtering
- Sync version indexes for conflict resolution queries
- Foreign key indexes for relationship lookups

**Type Safety**
- Strict TypeScript interfaces prevent runtime type errors
- Zod schema validation for API boundary type checking
- Database enum constraints match TypeScript union types
- Shared type definitions ensure consistency across frontend/backend

## Testing

### Test Location Standards
- Unit tests: `__tests__/` directory alongside source files
- Database tests: `__tests__/database/` for schema and RLS testing
- Type tests: `__tests__/types/` for interface validation
- Migration tests: `__tests__/migrations/` for version control testing

### Testing Frameworks and Patterns
- Jest for unit testing with TypeScript support
- Supabase Test Client for database integration testing
- Multiple test database instances for RLS policy testing
- Test data fixtures for consistent database seeding
- TypeScript compiler integration for type validation testing

### Specific Testing Requirements for This Story
- Verify all TypeScript interfaces match database schema exactly
- Test RLS policies prevent unauthorized family data access
- Validate all database constraints (CHECK, FOREIGN KEY, UNIQUE)
- Test migration scripts execute without errors in both directions
- Verify performance indexes improve query execution times
- Test data validation at both TypeScript and database levels
- Ensure Supabase client configuration works with created schema

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-01 | 1.0 | Initial story creation with comprehensive database architecture context | System |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by the QA Agent after story completion*