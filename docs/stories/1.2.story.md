# <!-- Powered by BMAD™ Core -->

# Story 1.2: Authentication System Foundation

## Status
Draft

## Story
**As a** family member,  
**I want** to create a secure personal account and log in reliably,  
**so that** my family's coordination data remains private and accessible only to authorized family members.

## Acceptance Criteria

1. **User registration endpoint** accepts email, password, and basic profile information with validation
2. **Secure password hashing** implemented using bcrypt with appropriate salt rounds
3. **JWT authentication system** working with token generation, validation, and expiration handling
4. **Login/logout functionality** with secure token storage and automatic expiration handling
5. **Basic user profile management** allowing name and email updates
6. **Registration and login UI** mobile-optimized with clear error messaging and validation feedback

## Tasks / Subtasks

- [ ] Implement Supabase Auth integration (AC: 1, 2, 3)
  - [ ] Configure Supabase Auth client in Next.js application
  - [ ] Set up Row Level Security (RLS) policies for family data isolation
  - [ ] Create authentication service layer with Supabase Auth
  - [ ] Implement JWT token handling through Supabase client
  - [ ] Add password validation and security requirements
- [ ] Create user registration system (AC: 1, 5)
  - [ ] Build registration API route using Supabase Auth signup
  - [ ] Implement user profile creation in family_members table
  - [ ] Add email validation and duplicate checking
  - [ ] Create user profile update functionality
  - [ ] Add avatar color assignment for family member identification
- [ ] Implement login/logout functionality (AC: 4)
  - [ ] Build login API route using Supabase Auth signIn
  - [ ] Implement secure session management with Supabase
  - [ ] Create logout functionality with token cleanup
  - [ ] Add automatic token refresh handling
  - [ ] Implement session persistence across browser sessions
- [ ] Build authentication UI components (AC: 6)
  - [ ] Create responsive Login component with validation
  - [ ] Build Register component with password requirements
  - [ ] Implement AuthContext for app-wide authentication state
  - [ ] Add form validation with error messaging
  - [ ] Create protected route wrapper component
- [ ] Set up authentication middleware and guards (AC: 3, 4)
  - [ ] Create authentication middleware for API routes
  - [ ] Implement family data isolation middleware
  - [ ] Add JWT token validation for protected routes
  - [ ] Create role-based access control (admin/member)
  - [ ] Add rate limiting for authentication endpoints
- [ ] Implement comprehensive authentication testing
  - [ ] Unit tests for authentication service functions
  - [ ] API route tests for registration and login endpoints
  - [ ] Component tests for Login and Register forms
  - [ ] Integration tests for authentication flow
  - [ ] E2E tests for complete user authentication journey

## Dev Notes

### Previous Story Insights
Story 1.1 is currently in Draft status. The authentication system will build upon the foundational Next.js + Supabase integration established in Story 1.1. This story assumes the basic project structure and Supabase client configuration are already in place.

### Architecture Context

**Core Technology Stack** [Source: architecture/tech-stack.md]
- Authentication: Supabase Auth with JWT tokens (managed authentication with built-in user management, MFA support, automatic token refresh)
- Backend Framework: Next.js API Routes 14.2+ (serverless functions integrated with frontend)
- Database Service: Supabase PostgreSQL with Row Level Security for family data isolation
- Frontend Framework: Next.js 14.2+ with App Router (Server Components for performance)
- Frontend Language: TypeScript 5.2+ for type safety across components and API calls
- State Management: React Query 5.0+ for server state, Zustand 4.4+ for client state

**Project Structure Alignment** [Source: architecture/unified-project-structure.md]
Note: The documented structure shows a monorepo setup, but implementation uses Next.js integrated approach:

```
project-root/
├── src/
│   ├── app/                 # Next.js App Router pages
│   │   ├── auth/           # Authentication routes (/auth/login, /auth/register)
│   │   ├── api/            # API routes
│   │   │   └── auth/       # Authentication endpoints
│   ├── components/          # React components
│   │   ├── ui/             # Basic UI components (Button, Input)
│   │   └── layout/         # Layout and navigation
│   │   └── auth/           # Authentication-specific components
│   ├── lib/                # Utilities and configuration
│   │   ├── supabase.ts     # Supabase client setup
│   │   └── auth.ts         # Authentication utilities
│   ├── contexts/           # React contexts
│   │   └── AuthContext.tsx # Authentication context
│   └── middleware.ts       # Next.js middleware for auth
```

**Data Models** [Source: architecture/data-models.md]
- FamilyMember: Individual user account within family context
  - id: string (UUID) - Unique user identifier
  - familyId: string - Foreign key for family data isolation
  - email: string - Authentication credential and invitation target
  - passwordHash: string - Managed by Supabase Auth
  - name: string - Display name for task ownership visual identification
  - role: 'admin' | 'member' - Admin vs Member permissions
  - avatarColor: string - Consistent color coding per front-end spec
  - isActive: boolean - Account status management
  - createdAt, updatedAt, lastSeenAt: Date - Audit trail

**Database Schema** [Source: architecture/database-schema.md]
```sql
-- Family members with role-based permissions
CREATE TABLE family_members (
    id TEXT PRIMARY KEY,
    family_id TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    name TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('admin', 'member')),
    avatar_color TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT 1,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_seen_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (family_id) REFERENCES families (id) ON DELETE CASCADE
);
```

**API Specifications** [Source: architecture/backend-architecture.md]
- Authentication endpoints: `/api/auth/login`, `/api/auth/register`, `/api/auth/logout`, `/api/auth/refresh`
- JWT authentication middleware for protected routes
- Family data isolation enforcement through middleware
- Rate limiting: 5 attempts per 15 minutes for auth endpoints, 100 requests per minute for API
- Security headers for all API responses

**Frontend Component Architecture** [Source: architecture/frontend-architecture.md, architecture/components.md]
- AuthContext for app-wide authentication state management
- Protected route pattern for authenticated page access
- Login/Register components in `/src/app/auth/` directory
- Authentication service layer with Supabase integration
- Token management with automatic refresh handling

### Testing Requirements

**Test Organization** [Source: architecture/testing-strategy.md]
```
tests/
├── __tests__/              # Jest unit tests
│   ├── components/         # Component tests with React Testing Library
│   │   ├── auth/          # Login/Register component tests
│   ├── lib/               # Authentication service tests
│   ├── api/               # API route tests for auth endpoints
└── e2e/                   # Playwright E2E tests
    └── specs/             # Authentication flow E2E tests
```

**Testing Standards:**
- Frontend Tests: Jest + React Testing Library for authentication components and context
- API Tests: Jest + Supertest for authentication endpoints with Supabase test client
- E2E Tests: Playwright for complete authentication flows
- Test file naming: AuthComponent.test.tsx for unit tests, auth-flow.spec.ts for E2E
- All authentication components must have rendering and interaction tests
- API endpoints need tests for validation, security, and error scenarios

**Required Test Coverage:**
- User registration with validation and error handling
- Login flow with credential validation
- JWT token generation and validation
- Protected route access control
- Session persistence and refresh
- Family data isolation enforcement
- Rate limiting for authentication endpoints

### Security and Performance Considerations

**Authentication & Security** [Source: architecture/backend-architecture.md]
- Supabase Auth manages password hashing with bcrypt and appropriate salt rounds
- JWT token management with automatic refresh through Supabase client
- Row Level Security (RLS) policies for family data isolation
- Rate limiting middleware: 5 authentication attempts per 15 minutes
- Secure environment variable handling for API keys
- CORS configuration for API routes

**Family Data Isolation** [Source: architecture/coding-standards.md]
- All database queries must include family ID filtering
- Authentication middleware must enforce family membership validation
- JWT payload includes familyId for request-level isolation
- Role-based access control for admin vs member permissions

**Performance Requirements**
- Mobile-first responsive design for authentication forms
- Optimized token storage and management
- Minimal authentication bundle size
- Fast authentication state restoration on app startup

## Testing

### Test Location Standards
- Unit tests: `__tests__/` directory alongside source files
- Component tests: `__tests__/components/auth/ComponentName.test.tsx`
- API route tests: `__tests__/api/auth/route.test.ts`
- E2E tests: `e2e/specs/authentication.spec.ts`

### Testing Frameworks and Patterns
- Jest for unit testing with TypeScript support
- React Testing Library for authentication component testing
- Playwright for E2E testing of authentication flows
- Supabase test client for API route testing
- Mock authentication state for unit tests

### Specific Testing Requirements for This Story
- Test user registration with email validation and profile creation
- Verify login functionality with credential validation and JWT token handling
- Test protected route access control and redirection
- Validate authentication context state management
- Test form validation and error messaging display
- Verify session persistence and automatic token refresh
- Test rate limiting enforcement for authentication endpoints
- Validate family data isolation in authentication flow

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-01 | 1.0 | Initial story creation with architecture context | System |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*This section will be populated by the QA Agent after story completion*