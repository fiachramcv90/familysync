# <!-- Powered by BMADâ„¢ Core -->

# Story S1.2: Replace Mock Data with Real Supabase Integration

## Status
ðŸš¨ **CRITICAL BLOCKER** - Not Started

## Story
**As a** authenticated family member,  
**I want** the dashboard to display real data from my family's Supabase database,  
**so that** I can see actual tasks, events, and family member information instead of hardcoded mock data.

## Acceptance Criteria

1. **Remove all mock data** from useFamilyTasks.ts and replace with real Supabase queries
2. **Implement authenticated user context** to fetch data for the correct family
3. **Handle empty states gracefully** when families have no tasks, events, or members
4. **Ensure Row Level Security (RLS)** is respected in all data queries
5. **Implement proper error handling** for failed API requests with user-friendly messages
6. **Dashboard displays real data** from authenticated user's family in Supabase

## Tasks / Subtasks

- [ ] **Remove mock data implementation** (AC: 1)
  - [ ] Delete mock family members, tasks, and events arrays from useFamilyTasks.ts
  - [ ] Remove mock data generation logic from taskService.getTasksForWeek
  - [ ] Clean up mock data from createTask and updateTask functions
  - [ ] Remove temporary mock family ID references
- [ ] **Implement authenticated user context** (AC: 2)
  - [ ] Create useAuthenticatedUser hook to get current user from Supabase Auth
  - [ ] Fetch user's family membership from family_members table
  - [ ] Handle case where user is not part of any family yet
  - [ ] Ensure all queries filter by authenticated user's family_id
- [ ] **Implement real Supabase queries** (AC: 1, 4)
  - [ ] Replace getFamilyMembers with real query to family_members table
  - [ ] Implement getTasksForWeek with proper date filtering and family_id filtering
  - [ ] Add getEventsForWeek query for calendar events
  - [ ] Ensure all queries respect RLS policies and family data isolation
- [ ] **Handle empty states and edge cases** (AC: 3)
  - [ ] Handle new families with no tasks or events
  - [ ] Handle users not assigned to any family
  - [ ] Handle database connection failures gracefully
  - [ ] Provide appropriate loading states during data fetching
- [ ] **Implement error handling and retry logic** (AC: 5)
  - [ ] Add proper error boundaries for query failures
  - [ ] Implement retry logic for failed network requests
  - [ ] Display user-friendly error messages
  - [ ] Add fallback states for partial data loading failures
- [ ] **Update data aggregation logic** (AC: 6)
  - [ ] Implement real weekly dashboard data aggregation
  - [ ] Calculate actual task completion rates and statistics
  - [ ] Group real tasks and events by day for calendar display
  - [ ] Generate proper family member workload summaries

## Dev Notes

### Current Issue Analysis
The dashboard currently uses extensive mock data in `useFamilyTasks.ts` which prevents authenticated users from seeing their actual family data. This creates a confusing experience where users can log in but see fake information.

**Mock Data to Replace:**
```typescript
// These need to be replaced with real Supabase queries:
const mockFamilyMembers: FamilyMember[] = [...]
const mockTasks: Task[] = [...]
const mockEvents: Event[] = [...]
```

### Architecture Context

**Authentication Flow:**
```typescript
// Expected flow:
1. User logs in via Supabase Auth
2. Get user.id from auth session
3. Query family_members table to find user's family_id
4. Use family_id to filter all subsequent queries
5. Respect RLS policies for data isolation
```

**Required Supabase Queries:**
```typescript
// Real implementations needed:
- supabase.from('family_members').select('*').eq('user_id', user.id)
- supabase.from('tasks').select('*').eq('family_id', familyId).gte('due_date', weekStart)
- supabase.from('events').select('*').eq('family_id', familyId).gte('start_date_time', weekStart)
```

**Data Model Alignment:**
Must ensure compatibility with existing database schema:
- families table with RLS policies
- family_members table with user relationships  
- tasks table with proper foreign keys
- events table for calendar functionality

### Security Requirements

**Row Level Security (RLS):**
- All queries must respect family data isolation
- Users can only see data from their own family
- No cross-family data leakage
- Proper authentication checks in all queries

**Error Handling:**
- Never expose database errors to users
- Graceful degradation when data is unavailable
- Proper loading states during authentication checks

### Performance Considerations

**Query Optimization:**
- Use Supabase select() with specific fields to minimize data transfer
- Implement proper indexing on commonly queried fields (family_id, due_date)
- Cache family membership to avoid repeated queries
- Use React Query caching effectively

**Loading States:**
- Immediate loading indicators
- Progressive data loading (members first, then tasks)
- Skeleton components during initial load

### Dependencies
- **Requires**: Story S1.1 (components must exist for testing)
- **Blocks**: All other dashboard functionality
- **Authentication**: Assumes Supabase Auth is working (from previous implementation)

## Testing

### Test Location Standards
- Hook tests: `src/__tests__/hooks/useFamilyTasks.test.ts`
- Integration tests: `src/__tests__/integration/dashboard-data.test.ts`
- E2E tests: `e2e/dashboard-real-data.spec.ts`

### Testing Requirements for This Story
- Test authenticated user data fetching
- Verify family data isolation (RLS compliance)
- Test empty state handling for new families
- Validate error handling for network failures
- Confirm real data displays correctly in dashboard components

### Mock Strategy for Tests
```typescript
// Test approach:
- Mock Supabase client for unit tests
- Use test database for integration tests  
- Create test families with known data
- Verify RLS policies prevent cross-family access
```

## Security Checklist

- [ ] All queries include family_id filtering
- [ ] RLS policies tested and working
- [ ] No hardcoded family IDs in production code
- [ ] Authentication state properly checked
- [ ] Error messages don't expose internal details
- [ ] User input properly sanitized in queries

## Performance Checklist

- [ ] Queries optimized with proper field selection
- [ ] React Query caching configured appropriately
- [ ] Loading states implemented for better UX
- [ ] Error retry logic doesn't cause infinite loops
- [ ] Database indexes support query patterns

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-10 | 1.0 | Initial story for real data integration | BMad Orchestrator |

## Priority Classification

**Epic**: Project Stabilization  
**Phase**: 1 - Critical Blockers  
**Priority**: P0 - Critical  
**Estimated Effort**: 4-5 hours  
**Assigned Agent**: `full-stack` specialist  
**Risk**: High - Data integrity and security critical  
**Dependencies**: Story S1.1 (components must exist)